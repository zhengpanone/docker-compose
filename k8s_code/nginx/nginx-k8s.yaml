---
# 1. ÂàõÂª∫ PersistentVolume (PV) - Â≠òÂÇ®ÈùôÊÄÅÊñá‰ª∂
apiVersion: v1
kind: PersistentVolume
metadata:
  name: nginx-html-pv
  labels:
    app: nginx
    type: html
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: manual
  hostPath:
    path: /mnt/host/d/dockerstore/nginx/html
    type: DirectoryOrCreate

---
# 2. ÂàõÂª∫ PersistentVolume (PV) - Â≠òÂÇ®Êó•Âøó
apiVersion: v1
kind: PersistentVolume
metadata:
  name: nginx-logs-pv
  labels:
    app: nginx
    type: logs
spec:
  capacity:
    storage: 2Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: manual
  hostPath:
    path: /mnt/host/d/dockerstore/nginx/logs
    type: DirectoryOrCreate

---
# 3. ÂàõÂª∫ PersistentVolumeClaim (PVC) - HTML
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nginx-html-pvc
  namespace: default
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: manual
  resources:
    requests:
      storage: 5Gi
  selector:
    matchLabels:
      app: nginx
      type: html

---
# 4. ÂàõÂª∫ PersistentVolumeClaim (PVC) - Logs
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nginx-logs-pvc
  namespace: default
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: manual
  resources:
    requests:
      storage: 2Gi
  selector:
    matchLabels:
      app: nginx
      type: logs

---
# 5. ÂàõÂª∫ ConfigMap (Nginx ÈÖçÁΩÆ)
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: default
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;
    
    events {
        worker_connections 1024;
        use epoll;
    }
    
    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        
        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';
        
        access_log /var/log/nginx/access.log main;
        
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        client_max_body_size 20M;
        
        # Gzip ÂéãÁº©
        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/xml text/javascript 
                   application/json application/javascript application/xml+rss 
                   application/rss+xml font/truetype font/opentype 
                   application/vnd.ms-fontobject image/svg+xml;
        
        # ÂåÖÂê´ËôöÊãü‰∏ªÊú∫ÈÖçÁΩÆ
        include /etc/nginx/conf.d/*.conf;
    }
  
  default.conf: |
    server {
        listen 80;
        server_name _;
        
        root /usr/share/nginx/html;
        index index.html index.htm;
        
        # ËÆøÈóÆÊó•Âøó
        access_log /var/log/nginx/access.log main;
        error_log /var/log/nginx/error.log warn;
        
        # ‰∏ªÈ°µ
        location / {
            try_files $uri $uri/ /index.html;
        }
        
        # ÂÅ•Â∫∑Ê£ÄÊü•Á´ØÁÇπ
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
        
        # Áä∂ÊÄÅÈ°µÈù¢
        location /nginx_status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            allow 10.0.0.0/8;
            deny all;
        }
        
        # ÈùôÊÄÅËµÑÊ∫êÁºìÂ≠ò
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
        
        # ÂÆâÂÖ®Â§¥
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        
        # Á¶ÅÊ≠¢ËÆøÈóÆÈöêËóèÊñá‰ª∂
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }
    }
  
---
# 6. ÂàõÂª∫ Job - ÂàùÂßãÂåñ HTML Êñá‰ª∂
apiVersion: batch/v1
kind: Job
metadata:
  name: nginx-init-html
  namespace: default
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: init
        image: busybox:1.36
        command: ['sh', '-c']
        args:
          - |
            echo "ÂºÄÂßãÂàùÂßãÂåñ HTML Êñá‰ª∂..."
            
            if [ ! -f /html/index.html ]; then
              cat > /html/index.html << 'EOF'
            <!DOCTYPE html>
            <html lang="zh-CN">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Nginx on Kubernetes</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        min-height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                    }
                    .container {
                        background: white;
                        border-radius: 20px;
                        padding: 60px 40px;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        text-align: center;
                        max-width: 600px;
                        width: 100%;
                        animation: fadeIn 0.5s ease-in;
                    }
                    @keyframes fadeIn {
                        from { opacity: 0; transform: translateY(20px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                    h1 {
                        color: #333;
                        font-size: 2.5em;
                        margin-bottom: 20px;
                    }
                    .logo {
                        font-size: 80px;
                        margin-bottom: 20px;
                        animation: bounce 2s infinite;
                    }
                    @keyframes bounce {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-10px); }
                    }
                    p {
                        color: #666;
                        font-size: 1.2em;
                        line-height: 1.6;
                        margin-bottom: 30px;
                    }
                    .info {
                        background: #f8f9fa;
                        border-radius: 10px;
                        padding: 20px;
                        margin-top: 30px;
                    }
                    .info-item {
                        display: flex;
                        justify-content: space-between;
                        padding: 10px 0;
                        border-bottom: 1px solid #e0e0e0;
                    }
                    .info-item:last-child { border-bottom: none; }
                    .label {
                        font-weight: 600;
                        color: #555;
                    }
                    .value {
                        color: #667eea;
                        font-family: monospace;
                    }
                    .btn {
                        display: inline-block;
                        padding: 12px 30px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        text-decoration: none;
                        border-radius: 25px;
                        margin: 10px;
                        transition: all 0.3s;
                        border: none;
                        cursor: pointer;
                        font-size: 16px;
                    }
                    .btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
                    }
                    .status {
                        display: inline-block;
                        width: 10px;
                        height: 10px;
                        background: #4caf50;
                        border-radius: 50%;
                        margin-right: 5px;
                        animation: pulse 2s infinite;
                    }
                    @keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.5; }
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="logo">üöÄ</div>
                    <h1>Nginx on Kubernetes</h1>
                    <p>ÊÇ®ÁöÑ Nginx ÊúçÂä°Âô®Â∑≤Âú® Kubernetes ÈõÜÁæ§‰∏≠ÊàêÂäüËøêË°åÔºÅ</p>
                    <p>Êï∞ÊçÆÊåÅ‰πÖÂåñÂ≠òÂÇ®Âú® PV/PVC ‰∏≠</p>
                    
                    <div class="info">
                        <div class="info-item">
                            <span class="label">ÊúçÂä°Âô®</span>
                            <span class="value">Nginx 1.25</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Âπ≥Âè∞</span>
                            <span class="value">Kubernetes</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Â≠òÂÇ®</span>
                            <span class="value">PV/PVC</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Áä∂ÊÄÅ</span>
                            <span class="value"><span class="status"></span>Running</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Êó∂Èó¥</span>
                            <span class="value" id="time">--:--:--</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <a href="/health" class="btn">ÂÅ•Â∫∑Ê£ÄÊü•</a>
                        <button class="btn" onclick="testAPI()">ÊµãËØï API</button>
                    </div>
                </div>
                
                <script>
                    function updateTime() {
                        const now = new Date();
                        document.getElementById('time').textContent = now.toLocaleTimeString('zh-CN');
                    }
                    setInterval(updateTime, 1000);
                    updateTime();
                    
                    function testAPI() {
                        fetch('/health')
                            .then(response => response.text())
                            .then(data => {
                                alert('ÂÅ•Â∫∑Ê£ÄÊü•ÊàêÂäüÔºÅ\nÂìçÂ∫î: ' + data);
                            })
                            .catch(error => {
                                alert('ÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•: ' + error);
                            });
                    }
                </script>
            </body>
            </html>
            EOF
              echo "‚úì HTML Êñá‰ª∂ÂàõÂª∫ÂÆåÊàê"
            else
              echo "HTML Êñá‰ª∂Â∑≤Â≠òÂú®ÔºåË∑≥ËøáÂàõÂª∫"
            fi
            
            ls -lh /html/
        volumeMounts:
        - name: html
          mountPath: /html
      volumes:
      - name: html
        persistentVolumeClaim:
          claimName: nginx-html-pvc
  

---
# 7. ÂàõÂª∫ Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: default
  labels:
    app: nginx
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.25-alpine
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
          name: http
          protocol: TCP
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: nginx-config
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: default.conf
        - name: nginx-html
          mountPath: /usr/share/nginx/html
        - name: nginx-logs
          mountPath: /var/log/nginx
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 2
          failureThreshold: 3
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
      - name: nginx-html
        persistentVolumeClaim:
          claimName: nginx-html-pvc
      - name: nginx-logs
        persistentVolumeClaim:
          claimName: nginx-logs-pvc

---
# 8. ÂàõÂª∫ Service (ClusterIP - ÈõÜÁæ§ÂÜÖËÆøÈóÆ)
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
  namespace: default
  labels:
    app: nginx
spec:
  selector:
    app: nginx
  type: ClusterIP
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    name: http

---
# 9. ÂàõÂª∫ Service (NodePort - Â§ñÈÉ®ËÆøÈóÆ)
apiVersion: v1
kind: Service
metadata:
  name: nginx-service-nodeport
  namespace: default
  labels:
    app: nginx
spec:
  selector:
    app: nginx
  type: NodePort
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30080
    protocol: TCP
    name: http